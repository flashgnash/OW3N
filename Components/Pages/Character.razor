@page "/characters/{characterId:int}"
@inject PlayerCharacterService CharService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@attribute [Authorize(Policy = "HasDiscordId")]
@inject UserState UserState
@rendermode InteractiveServer


      <RollMenu Character="@Char"/>

    </div>
  </dialog>

  <div class="disable-dbl-tap-zoom container mt-4">
    <div class="w-100 p-2">
      <span class="fs-2">@Char.Name — Level @Char.Level </span>

      <button
        onClick="rollDialog.showModal()"
        class="btn btn-primary float-right fs-2"
      >
        🎲
      </button>
    </div>
    <br />

    <!-- Stats -->
    <div class="d-flex flex-wrap" style="text-size: 10px">

    <div class="d-flex flex-wrap" style="text-size: 10px">
      @if(Char?.Stats != null){
      <StatBlock Stats="@Char.Stats" FlexFill="true" />
      }
    </div>
    <Radar/>
    </div>

    @if(Char?.Gauges != null){
    <!-- Globes -->
    <div class="d-flex">
      @foreach (var gauge in Char.Gauges) {
        @if(!(gauge?.Max == 0 && gauge?.Value == 0)) {
        <Orb
          Name="@gauge.Name"
          Colour="@gauge.Colour"
          Value="@gauge.Value"
          Max="@gauge.Max"
        />
        }
      }
    </div>

    }



    <div class="">

      <div class="flex-grow-2 flex-row flex-wrap">
  
        @if(Char?.Hunger != null && Char?.Hunger != 0) {
          <div class="card flex-fill">
            <div class="card-header">Hunger:</div>

            <div class="card-body fs-7">

              <span>@Char.Hunger / 10</span>
              <br/>
              <span class="d-none d-md-inline">
                <CharBar  Repeat="@(Char.Hunger ?? 10)" Icon="🍖" />
              </span>
            </div>
        }
        <div class="">
            <div class="flex-grow-2 flex-row flex-wrap">
                @if (Char?.Hunger != null && Char?.Hunger != 0)
                {
                    <div class="card flex-fill">
                        <div class="card-header">Hunger:</div>
                        <div class="card-body fs-7">
                            <span>
                                @Char.Hunger / 10
                            </span>
                            <br />
                            <span class="d-none d-md-inline">
                                <CharBar Repeat="@(Char.Hunger ?? 10)" Icon="🍖" />
                            </span>
                        </div>
                    </div>
                }
            </div>
        </div>


        <div class="d-flex flex-wrap">
            <div class="flex-row flex-grow-1">
                <div class="flex-fill">
                    <DescriptableList Name="Inventory" Descriptables="@(Char.Inventory.Cast<IDescriptable>())" />
                </div>
                <div class="flex-fill">
                    <DescriptableList Name="Spells" Descriptables="@(Char.Spells.Cast<IDescriptable>())" />
                </div>
            </div>
        </div>

        
        <!-- Quick and dirty margin at the bottom if scrolling -->
        <br>
        <br>
    </div>
}
else
{
    <h1>Either this character doesn't exist or you don't have access</h1>
}




@code {
  PlayerCharacter? Char;
  [Parameter] public int CharacterId { get; set; }

  protected async override Task OnInitializedAsync() {
    var character = CharService.GetById(CharacterId);

@code
{
    PlayerCharacter? Char;

    [Parameter] public int CharacterId { get; set; }

    public async Task GaugeChangedCallback(Gauge gauge) {
        await CharService.UpdateAsync(Char);
        Console.WriteLine("Hello world");
    }


    protected async override Task OnInitializedAsync()
    {
        var character = await CharService.GetByIdAsync(CharacterId);

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var discordId = user.FindFirst("discord_id")?.Value ?? "Not logged in";

        // Only present the user with data if they are the character's owner
        // (this is only safe because I'm using serverside blazor)
        if (character?.UserId == discordId)
        {
            UserState.SelectedCharacter = character;
            Char = character;
        }
        else
        {
            Navigation.NavigateTo("/forbidden");
        }
    }
}
