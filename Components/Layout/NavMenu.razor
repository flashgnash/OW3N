@inject IConfiguration Configuration
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@inject PlayerCharacterService CharService
@inject CampaignService CampaignService

<div class="top-row navbar navbar-dark">
    <div class="container-fluid">
        <span>
            <img src="favicon.png" alt="favicon" style="border-radius:50%;" width="32" height="32">
            <a class="navbar-brand" href="">0W3N</a>
        </span>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

    <div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
        <nav class="nav flex-column">
            <!-- <div class="nav-item px-3"> -->
                <!-- <NavLink class="nav-link" href="" Match="NavLinkMatch.All"> -->
                    <!-- <span class="bi bi-house-door-fill-nav-menu" aria-hidden="true"></span> Home -->
                <!-- </NavLink> -->
            <!-- </div> -->

@if(loggedIn) {


            <div class="nav-item px-3">
                <NavLink class="nav-link" href="/campaigns">
                    <span class="bi bi-list-nested-nav-menu" aria-hidden="true"></span> My Campaigns
                </NavLink>
                
                @if(Campaigns != null){

                    @foreach(var campaign in Campaigns){
                      <NavLink class="nav-link" style="width: 95%" href="@($"/campaigns/{campaign.Id}")">@campaign.Name</NavLink>
                    }

                }
            </div>
            <br>

            <div class="nav-item px-3">
                <NavLink class="nav-link" href="characters">
                    <span class="bi bi-list-nested-nav-menu" aria-hidden="true"></span> My Characters
                </NavLink>
                @if(Characters != null){

                    @foreach(var character in Characters ){
                      <NavLink class="nav-link" style="width: 95%" href="@($"/characters/{character.Id}")">@character.Name</NavLink>
                    }

                }
                
            </div>            
            
}

else {

            <div class="nav-item px-3 p-3 mt-auto">
                <NavLink class="nav-link" href="@discordLoginUrl">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-fill" viewBox="0 0 16 16">
                      <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/>
                    </svg>
                     Log in
                </NavLink>
            </div>
}
        </nav>


       </div>

    


@code {
    string discordLoginUrl;
    bool loggedIn; 


    IEnumerable<PlayerCharacter> Characters {get; set;}
    IEnumerable<Campaign> Campaigns {get; set;}

    protected async override Task OnInitializedAsync()
    {
        var discordConfig = Configuration.GetSection("Discord");
        var clientId = discordConfig["ClientId"];

        var uri = new Uri(Navigation.Uri);
        var redirect = $"{uri.Scheme}://{uri.Host}{(uri.IsDefaultPort ? "" : $":{uri.Port}")}/auth/callback";
       
        var state = Guid.NewGuid().ToString();

        discordLoginUrl =
            $"https://discord.com/api/oauth2/authorize?client_id={clientId}&redirect_uri={Uri.EscapeDataString(redirect)}&response_type=code&scope=identify&state={state}";


        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        loggedIn = user.FindFirst("discord_id")?.Value != null;

        // get claim
        var discordId = user.FindFirst("discord_id")?.Value;
        var discordName = user.FindFirst("discord_name")?.Value;

        if(discordId != null){
          Characters = (await CharService?.GetByDiscordIdAsync(discordId)).Reverse();
          Campaigns = (await CampaignService?.GetByDiscordIdAsync(discordId)).Reverse();
        }

            
    }
}
